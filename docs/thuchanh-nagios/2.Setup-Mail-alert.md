# Cấu hình cảnh báo Nagios qua mail

# Mục lục:
- [1. Tính năng gửi cảnh báo qua email](#1)
- [2. Cấu hình cánh báo qua Gmail](#2)
- [3. Cấu hình cảnh báo qua mail domain](#3)
- [4. Gửi cảnh báo khi có sự cố](#4)
	- [4.1 Gửi cảnh báo khi dịch vụ down](#41)
	- [4.2 Gửi cảnh báo theo ngưỡng](#42)
- [5. Tài liệu tham khảo](#5)

----------------------------------------------

Lưu ý: Chọn 1 trong 2 cách (gmail & mail domain)để cấu hình gửi mail cảnh báo

<a name="1"></a>
## 1. Tính năng gửi cảnh báo qua email
Trong thực tế, người quản trị viên không phải lúc nào cũng có thể ngồi theo dõi và nắm bắt các hoạt động của hệ thống qua giao diện giám sát. Bởi vậy bất cứ hệ thống giám sát nào cũng cần cung cấp các chức năng thông báo về tình trạng của hệ thống qua các phương tiện truyền thông. Nagios cũng cấp tính năng thông báo các sự kiện xảy ra qua phương tiện truyền thông là email. Bài viết này sẽ cung cấp 2 cách để cấu hình gửi email thông báo đó là gửi qua Gmai hoặc qua mail domain

Trong bài viết này, tất cả các bước cấu hình đều thực hiện trên Nagios Sever sử dụng hệ điều hành Centos 7. Tham khảo cài đặt Nagios trên Centos 7 tại [đây](https://github.com/meditechopen/meditech-ghichep-nagios/blob/master/docs/thuchanh-nagios/1.Setup-CentOS-7.md)


<a name="2"></a>
## 2. Cấu hình cánh báo qua Gmail

- Cài đặt gói mail Postfix
```sh
yum -y install postfix cyrus-sasl-plain mailx
```

- Khởi động lại dịch vụ
```sh
systemctl restart postfix
systemctl enable postfix
```

- Chỉnh sửa file cấu hình `/etc/postfix/main.cf`
```sh
relayhost = [smtp.gmail.com]:587
smtp_use_tls = yes
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
smtp_tls_CAfile = /etc/ssl/certs/ca-bundle.crt
smtp_sasl_security_options = noanonymous
smtp_sasl_tls_security_options = noanonymous
```

- Tạo 1 file `/etc/postfix/sasl_passwd` để khai báo các thông số tài khoản mail xác thực
```sh
vi /etc/postfix/sasl_passwd

[smtp.gmail.com]:587 username:password
```

- Gửi mail test 
```sh
echo "This is a test." | mail -s "test message" trimq212@gmail.com
```

<img src="http://i.imgur.com/tponCE8.png">


<a name="3"></a>
## 3. Cấu hình cảnh báo qua mail domain

- Tải gói mail postfix
```sh
yum -y install postfix cyrus-sasl-plain mailx
```

- Chỉnh sửa file cấu hình. Thêm vào những dòng sau
```sh
vi /etc/postfix/main.cf 


relayhost =
sender_dependent_relayhost_maps = hash:/etc/postfix/relayhost_maps
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
smtp_sender_dependent_authentication = yes
smtp_sasl_security_options = noanonymous
#smtp_sasl_mechanism_filter = AUTH LOGIN
sender_canonical_maps = hash:/etc/postfix/sender_canonical
smtp_sasl_tls_security_options =
```

- Chỉnh sửa file cấu hình. Thêm thông tin về email và domain
```sh
vi /etc/postfix/relayhost_maps

email  [domain]
```

- Tạo 1 file và thêm thông số
```sh
vi /etc/postfix/sasl_passwd 


domain  username:password
```

- Cấu hình và phân quyền cho thư mục
```sh
postmap /etc/postfix/sasl_passwd
chown root:postfix /etc/postfix/sasl_passwd*
chmod 640 /etc/postfix/sasl_passwd*
systemctl reload postfix
```

- Gửi mai để test
```sh
echo "This is a test." | mail -s "test message" tri.maiquoc@meditech.vn
```

<img src="http://i.imgur.com/en1FOgO.png">


<a name="4"></a>
## 4. Gửi cảnh báo khi có sự cố

- Thêm các thông tin để liên lạc trong file `/usr/local/nagios/etc/objects/contacts.cfg`
```sh
vi /usr/local/nagios/etc/objects/contacts.cfg


define contact{
        contact_name                    nagiosadmin             ; Short name of user
        use                             generic-contact         ; Inherit default values from generic-contact template (defined above)
        alias                           Nagios Admin            ; Full name of user

        email                           trimq212@gmail.com        ; <<***** CHANGE THIS TO YOUR EMAIL ADDRESS ******

        service_notification_period             24x7
        service_notification_options            w,u,c,r,f,s
        service_notification_commands           notify-service-by-email
        host_notification_period                24x7
        host_notification_options               d,u,r,f,s
        host_notification_commands              notify-host-by-email
        }
```

- service_notification_options: trạng thái sẽ gửi cảnh báo của service
<ul>
<li>w: warning</li>
<li>u: unknown service</li>
<li>c: critical</li>
<li>r: recovery service (trạng thái OK)</li>
<li>f: cảnh báo khi service khởi động và tắt FLAPPING</li>
<li>s: gửi cảnh báo khi dịch vụ downtime trong lịch trình</li>
</ul>
	
- host_notification_options: trạng thái sẽ gửi cảnh báo của host 
<ul>
<li>d: DOWN, cảnh báo khi host rơi vào trạng thái down</li>
</ul>
	
- Thêm thông tin để gửi mail cảnh báo
```sh
vi /usr/local/nagios/etc/objects/localhost.cfg


# Define a service to check HTTP on the local machine.
# Disable notifications for this service by default, as not all users may have HTTP enabled.

define service{
        use                             local-service         ; Name of service template to use
        host_name                       localhost
        service_description             HTTP
        check_command                   check_http
        notifications_enabled           0
        contacts                        nagiosadmin
        }
```

- Khởi động lại dịch vụ
```sh
/etc/init.d/nagios restart
```



<a name="41"></a>
### 4.1 Gửi cảnh báo khi dịch vụ down

- Trên máy client, stop dịch vụ ssh

```sh
service ssh stop
```

- Thông tin trên dashboard

<img src="http://i.imgur.com/PiZI9vC.png">

- Email cảnh báo

<img src="http://i.imgur.com/fOF5odG.png">

- Khi khởi động lại dịch vụ ssh. Bản tin recovery báo trạng thái OK

<img src="http://i.imgur.com/lulFsEU.png">


### 4.2 Gửi cảnh báo theo ngưỡng
Cơ chế cảnh báo theo ngưỡng được đặt ra, khi dịch vụ cần giám sát vượt quá ngưỡng cho phép thì Nagios Core sẽ gửi cảnh báo đến người quản trị. Sử dụng cơ chế giám sát NRPE để thực hiện. Tham khảo cài đặt NRPE tại [đây](https://github.com/meditechopen/meditech-ghichep-nagios/blob/master/docs/thuchanh-nagios/3.Setup-NagiosNRPE.md)

#### Thực hiện trên client

- Chỉnh sửa file cấu hình Nagios trên client như sau:
```sh
vi /etc/nagios/nrpe.cfg
```

- Khai báo như sau
```sh
command[check_cpu]=/usr/lib/nagios/plugins/check_cpu.sh -w 70 -c 80
```

Trong đó:
<ul>
<li><b>command[check_cpu]</b>: khai báo tên của command để trên Nagios server có thể giao tiếp được với plugin trên client</li>
<li><b>/usr/lib/nagios/plugins/check_cpu.sh</b>: đường dẫn để thực thi plugin</li>
<li><b>-w 70 -c 80</b>: là ngưỡng cảnh báo đặt ra, ở đây trạng thái warning là trên 70% và trạng thái critical là trên 80%</li>

- Thử kiểm tra ngưỡng với công cụ `iperf` trên client cần giám sát
```sh
iperf -s
```

- Sau đó cho các máy khác đẩy dữ liệu về để CPU của client cần giám sát hoạt động quá ngưỡng. Sử dụng `iperf`
```sh
iperf - t 300 -c <IP_client>
```

- Kết quả là CPU của máy client đang chạy vượt ngưỡng cho phép và gửi đi mail cảnh báo như sau:

<img src="http://i.imgur.com/uRNJEJ9.png">

- Sau khi ngừng thực hiện `iperf` client sẽ trở về trạng thái ổn định và gửi mail thông báo

<img src="http://i.imgur.com/0I3coMG.png">



<a name="5"></a>
## 5. Tài liệu tham khảo

- https://access.redhat.com/documentation/en-US/Red_Hat_Storage/3/html/Console_Administration_Guide/Configuring_Nagios_to_Send_Mail_Notifications.html












